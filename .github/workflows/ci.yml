# ============================================
# Pipeline CI/CD complet pour TaskAPI
# Version 3 : multi-jobs avec dÃ©pendances
# ============================================

name: CI/CD - TaskAPI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_ENV: test
  CI: true

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1 : VÃ©rification de la syntaxe
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  lint:
    name: Lint - VÃ©rification syntaxe
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - run: npm ci
      - name: VÃ©rifier la syntaxe
        run: npx --yes syntax-check src/**/*.js

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2 : Tests unitaires
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    name: Tests - Jest
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - run: npm ci
      - name: ExÃ©cuter les tests
        run: npm test

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3 : DÃ©ploiement (conditionnel)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #deploy:
  #  name: Deploy - Production
  #  needs: [lint, test]
  #  runs-on: ubuntu-latest
  #  # DÃ©ployer UNIQUEMENT sur push vers main (pas les PR)
  #  if: github.event_name == 'push' && github.ref == 'refs/heads/main'
#
  #  steps:
  #    - name: DÃ©ploiement SSH
  #      uses: appleboy/ssh-action@v1
  #      with:
  #        host: ${{ secrets.SSH_HOST }}
  #        username: ${{ secrets.SSH_USER }}
  #        key: ${{ secrets.SSH_PRIVATE_KEY }}
  #        port: ${{ secrets.SSH_PORT }}
  #        script: |
  #          cd /var/www/task-api
  #          git pull origin main
  #          npm ci --production
  #          pm2 reload task-api
#
  #    - name: RÃ©sumÃ© du dÃ©ploiement
  #      run: |
  #        echo "## ðŸš€ DÃ©ploiement rÃ©ussi" >> $GITHUB_STEP_SUMMARY
  #        echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
  #        echo "- Par: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
  #        echo "- Date: $(date)" >> $GITHUB_STEP_SUMMARY